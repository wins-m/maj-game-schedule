<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººæ—¶é—´è¡¨</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/schedule.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸ªäººæ—¶é—´è¡¨</h1>
            <a href="index.html" class="btn btn-secondary">è¿”å›åˆ†æ¡Œè¡¨</a>
        </header>

        <main>
            <div id="player-info" class="player-info"></div>
            
            <div class="schedule-instructions">
                <p>è¯·å‹¾é€‰æ‚¨æœªæ¥7å¤©çš„ç©ºé—²æ—¶é—´æ®µï¼ˆæ—©ã€ä¸­ã€æ™šï¼‰</p>
                <p class="batch-hint">ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ—¥æœŸå¯æ‰¹é‡é€‰æ‹©æ•´è¡Œï¼Œç‚¹å‡»æ—¶æ®µå¯æ‰¹é‡é€‰æ‹©æ•´åˆ—</p>
            </div>

            <div id="schedule-table" class="schedule-table">
                <!-- æ—¶é—´è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="schedule-actions">
                <button id="save-schedule-btn" class="btn btn-primary">ä¿å­˜æ—¶é—´è¡¨</button>
                <button id="clear-schedule-btn" class="btn btn-secondary">æ¸…ç©ºé€‰æ‹©</button>
            </div>
        </main>
    </div>

    <script src="js/storage-api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/schedule.js"></script>
    <script>
        // ä¸ªäººæ—¶é—´è¡¨é¡µé¢é€»è¾‘
        (function() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const playerId = parseInt(urlParams.get('playerId'));

            if (!playerId) {
                alert('ç¼ºå°‘é€‰æ‰‹IDå‚æ•°');
                window.location.href = 'index.html';
                return;
            }

            // åˆå§‹åŒ–
            (async function() {
                try {
                    await Storage.init();
                    const player = await Storage.getPlayer(playerId);
                    
                    if (!player) {
                        alert('é€‰æ‰‹ä¸å­˜åœ¨');
                        window.location.href = 'index.html';
                        return;
                    }

                    // æ¸²æŸ“é€‰æ‰‹ä¿¡æ¯
                    const playerInfoEl = document.getElementById('player-info');
                    playerInfoEl.innerHTML = `
                        <h2>${player.name} çš„æ—¶é—´è¡¨</h2>
                        <p>å½“å‰ç§¯åˆ†ï¼š${player.totalScore}</p>
                    `;

                    // æ¸²æŸ“æ—¶é—´è¡¨
                    await renderSchedule();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            })();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);
            document.getElementById('clear-schedule-btn').addEventListener('click', clearSchedule);

            /**
             * æ¸²æŸ“æ—¶é—´è¡¨
             */
            async function renderSchedule() {
                const days = Utils.getNextDays(7);
                const periods = Utils.getPeriods();
                const selectedTimes = await Schedule.getSelectedTimes(playerId);

                let html = '<table class="schedule-grid"><thead><tr><th>æ—¥æœŸ</th>';
                periods.forEach(period => {
                    html += `<th class="period-header" data-period="${period.key}">${period.name}</th>`;
                });
                html += '</tr></thead><tbody>';

                days.forEach(day => {
                    html += `<tr>
                        <td class="day-cell batch-select-row" data-date="${day.dateStr}">
                            <div class="day-name">${day.dateStr}</div>
                            <div class="weekday">æ˜ŸæœŸ${day.weekday}</div>
                        </td>`;
                    
                    periods.forEach(period => {
                        const timeKey = Utils.getTimeKey(day.dateStr, period.key);
                        const isSelected = selectedTimes.includes(timeKey);
                        html += `
                            <td class="time-cell">
                                <label class="time-checkbox">
                                    <input type="checkbox" 
                                           data-date="${day.dateStr}" 
                                           data-period="${period.key}"
                                           ${isSelected ? 'checked' : ''}>
                                    <span class="checkmark"></span>
                                </label>
                            </td>
                        `;
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';

                document.getElementById('schedule-table').innerHTML = html;

                // ç»‘å®šæ•´è¡Œé€‰æ‹©ï¼ˆç‚¹å‡»æ—¥æœŸå•å…ƒæ ¼ï¼‰
                document.querySelectorAll('.batch-select-row').forEach(cell => {
                    cell.addEventListener('click', function(e) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œä¸è§¦å‘æ•´è¡Œé€‰æ‹©
                        if (e.target.closest('.time-checkbox')) return;
                        
                        const dateStr = this.dataset.date || 
                            this.querySelector('.day-name')?.textContent;
                        if (dateStr) {
                            toggleRow(dateStr);
                        }
                    });
                });

                // ç»‘å®šæ•´åˆ—é€‰æ‹©ï¼ˆç‚¹å‡»æ—¶æ®µè¡¨å¤´ï¼‰
                document.querySelectorAll('.period-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const period = this.dataset.period;
                        toggleColumn(period);
                    });
                });
            }

            /**
             * åˆ‡æ¢æ•´è¡Œé€‰æ‹© (çº¯å‰ç«¯ DOM æ“ä½œ)
             */
            function toggleRow(dateStr) {
                const checkboxes = document.querySelectorAll(`input[data-date="${dateStr}"]`);
                const checkboxArr = Array.from(checkboxes);
                const allChecked = checkboxArr.every(cb => cb.checked);
                checkboxArr.forEach(cb => cb.checked = !allChecked);
            }

            /**
             * åˆ‡æ¢æ•´åˆ—é€‰æ‹© (çº¯å‰ç«¯ DOM æ“ä½œ)
             */
            function toggleColumn(period) {
                const checkboxes = document.querySelectorAll(`input[data-period="${period}"]`);
                const checkboxArr = Array.from(checkboxes);
                const allChecked = checkboxArr.every(cb => cb.checked);
                checkboxArr.forEach(cb => cb.checked = !allChecked);
            }

            /**
             * ä¿å­˜æ—¶é—´è¡¨
             */
            async function saveSchedule() {
                const saveBtn = document.getElementById('save-schedule-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'ä¿å­˜ä¸­...';

                try {
                    // ä»æ‰€æœ‰checkboxè·å–å½“å‰é€‰æ‹©çŠ¶æ€
                    const selectedTimes = [];
                    document.querySelectorAll('.time-checkbox input:checked').forEach(checkbox => {
                        const date = checkbox.dataset.date;
                        const period = checkbox.dataset.period;
                        selectedTimes.push(Utils.getTimeKey(date, period));
                    });
                    
                    await Schedule.savePlayerSchedule(playerId, selectedTimes);
                    
                    Utils.showMessage('ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (e) {
                    console.error(e);
                    Utils.showMessage('ä¿å­˜å¤±è´¥', 'error');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜æ—¶é—´è¡¨';
                }
            }

            /**
             * æ¸…ç©ºé€‰æ‹©
             */
            function clearSchedule() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰é¡µé¢çš„é€‰æ‹©å—ï¼Ÿ(éœ€è¦ç‚¹å‡»ä¿å­˜æ‰ç”Ÿæ•ˆ)')) {
                    document.querySelectorAll('.time-checkbox input').forEach(cb => cb.checked = false);
                }
            }
        })();
    </script>
</body>
</html>

