# 麻将比赛管理系统

## 项目概述

一个用于管理麻将比赛分组、记分和时间表规划的网页应用系统。

## 核心功能

### 1. 比赛基础设置
- **默认配置**：8人参赛，4人每桌
- **比赛场次**：默认6场积分赛，每场2桌
- **初次分桌**：待定（可手动设置）

### 2. 积分赛管理
- 每场积分赛结束后，手动录入每位选手的积分
- 自动更新个人总积分
- 根据积分排名自动决定下一场分桌情况

### 3. 时间表规划（核心功能）
- 选手点击分桌表内自己的名字，进入个人时间表页面
- 时间表格式：7天 × 3时段（早、中、晚）= 21个时间格
- 选手可以勾选自己的空闲时间
- 填表后，分桌表内该选手被标记为"已填表"
- 当一桌4人都完成填表后，自动生成该桌4人都有空的时间段列表

## 技术栈

### 当前版本（服务器端存储 - 推荐）
- **前端框架**：原生 HTML + CSS + JavaScript
- **后端框架**：Node.js + Express
- **数据存储**：JSON文件（存储在服务器端）
- **部署方式**：Docker容器或Node.js套件
- **优势**：支持多设备、多浏览器数据同步

### 旧版本（纯前端 - 已弃用）
- **前端框架**：原生 HTML + CSS + JavaScript
- **数据存储**：LocalStorage（本地存储）
- **部署方式**：静态文件托管（Web Station）
- **限制**：数据存储在浏览器本地，无法跨设备同步

## 项目结构

```
majgame/
├── index.html              # 主页面（分桌表）
├── player-schedule.html    # 个人时间表页面
├── css/
│   ├── style.css          # 主样式文件
│   └── schedule.css       # 时间表样式
├── js/
│   ├── app.js             # 主应用逻辑
│   ├── game.js            # 比赛管理逻辑
│   ├── schedule.js        # 时间表管理逻辑
│   ├── storage.js         # 数据存储管理
│   └── utils.js           # 工具函数
├── data/
│   └── default-data.json  # 默认数据配置
└── README.md
```

## 数据模型

### 选手数据 (Player)
```javascript
{
  id: 1,
  name: "张三",
  totalScore: 0,           // 总积分
  scores: [10, 15, 12],    // 每场积分
  hasFilledSchedule: false // 是否已填时间表
}
```

### 比赛场次数据 (Game)
```javascript
{
  round: 1,                // 场次编号
  tables: [                // 桌次
    {
      tableId: 1,
      players: [1, 2, 3, 4], // 选手ID
      commonTimes: []        // 4人共同空闲时间（自动生成）
    }
  ],
  isCompleted: false       // 是否已完成
}
```

### 时间表数据 (Schedule)
```javascript
{
  playerId: 1,
  availableTimes: [       // 空闲时间段
    { day: 1, period: "morning" },  // 第1天早上
    { day: 2, period: "afternoon" }, // 第2天下午
    // ...
  ]
}
```

## 核心算法

### 1. 分桌算法（根据积分排名）
```
1. 按总积分降序排序选手
2. 采用"蛇形分组"策略：
   - 第1桌：排名 1, 4, 5, 8
   - 第2桌：排名 2, 3, 6, 7
   或采用其他平衡策略
```

### 2. 共同空闲时间匹配算法
```
1. 获取该桌4位选手的所有空闲时间
2. 找出4人时间表的交集
3. 生成共同空闲时间段列表
4. 按时间顺序排序显示
```

## 功能模块详细设计

### 模块1：主页面（分桌表）
- 显示当前场次的分桌情况
- 显示每位选手的当前积分
- 显示填表状态（已填/未填）
- 点击选手名字跳转到个人时间表
- 显示每桌的共同空闲时间（4人都填表后）

### 模块2：个人时间表页面
- 7天 × 3时段的表格（21个格子）
- 每个格子可勾选/取消
- 保存按钮保存时间表
- 返回按钮返回分桌表

### 模块3：积分录入
- 每场结束后弹出积分录入表单
- 为每位选手输入本场积分
- 自动计算并更新总积分
- 保存后自动生成下一场分桌

### 模块4：数据管理
- 初始化比赛数据
- 保存/加载比赛进度
- 重置比赛功能

## 开发计划

### 阶段1：基础框架
- [ ] 创建项目结构
- [ ] 搭建HTML页面框架
- [ ] 实现基础样式

### 阶段2：核心功能
- [ ] 实现选手数据管理
- [ ] 实现分桌算法
- [ ] 实现积分录入功能

### 阶段3：时间表功能
- [ ] 实现个人时间表页面
- [ ] 实现时间表勾选功能
- [ ] 实现共同空闲时间匹配算法

### 阶段4：优化与完善
- [ ] 数据持久化
- [ ] UI/UX优化
- [ ] 响应式设计
- [ ] 错误处理

## 使用说明

1. **初始化比赛**：设置8位选手姓名，开始第一场比赛
2. **初次分桌**：手动或随机分配第一场分桌
3. **进行比赛**：每场结束后录入积分
4. **填写时间表**：选手点击自己的名字，勾选空闲时间
5. **查看共同时间**：当一桌4人都填表后，自动显示共同空闲时间
6. **继续下一场**：系统自动根据积分排名分桌

## 群晖NAS部署方案

### 部署方式选择

#### 方案1：Docker部署（推荐）
**适用场景**：多设备使用，需要数据同步

**群晖套件安装要求**：
1. **Container Manager**（原Docker套件）
   - 在套件中心搜索并安装 "Container Manager"
   - 用于运行Docker容器

**部署步骤**：
1. 在群晖NAS中安装 **Container Manager**
2. 将所有项目文件上传到NAS（如 `/docker/majgame/`）
3. 在Container Manager中创建项目，使用项目目录中的 `docker-compose.yml`
4. 启动容器后，通过 `http://nas-ip:3000` 访问
5. （可选）配置反向代理和HTTPS

详细步骤请参考 `DEPLOY-SERVER.md`

#### 方案2：Node.js套件部署
**适用场景**：不使用Docker，直接运行Node.js

**群晖套件安装要求**：
1. **Node.js v18** 套件
   - 在套件中心搜索并安装 "Node.js v18"

**部署步骤**：
1. 安装Node.js套件
2. 上传项目文件到 `/web/majgame/`
3. 在server目录执行 `npm install`
4. 使用PM2或forever管理进程
5. 配置Web Station反向代理

详细步骤请参考 `DEPLOY-SERVER.md`

**优点**：
- 部署简单，无需额外配置
- 纯前端，性能好
- 无需数据库配置

**缺点**：
- 数据存储在浏览器，换设备需重新填写
- 无法实现多设备数据同步

#### 方案2：Docker容器部署（适合需要数据共享）
**适用场景**：需要多设备访问，数据需要持久化存储

**技术栈调整**：
- 前端：HTML + CSS + JavaScript
- 后端：Node.js + Express（轻量级）
- 数据存储：JSON文件或SQLite数据库
- 容器化：Docker + Docker Compose

**步骤**：
1. 创建 `Dockerfile` 和 `docker-compose.yml`
2. 在群晖NAS的Docker套件中部署
3. 配置数据卷挂载，持久化存储数据

**优点**：
- 数据存储在NAS上，多设备可访问
- 数据持久化，不会丢失
- 便于备份和管理

**缺点**：
- 需要开发后端API
- 部署相对复杂

#### 方案3：Node.js套件部署
**适用场景**：群晖NAS已安装Node.js套件

**步骤**：
1. 安装群晖Node.js套件
2. 使用PM2或forever管理Node.js进程
3. 配置反向代理（可选）

### 数据存储方案对比

| 方案 | 存储位置 | 多设备同步 | 部署复杂度 | 推荐场景 |
|------|---------|-----------|-----------|---------|
| LocalStorage | 浏览器 | ❌ | ⭐ 简单 | 单设备使用 |
| JSON文件 + 后端 | NAS文件系统 | ✅ | ⭐⭐ 中等 | 多设备共享 |
| SQLite + 后端 | NAS数据库 | ✅ | ⭐⭐⭐ 较复杂 | 长期使用 |

### 推荐实施路径

**第一阶段（快速上线）**：
- 使用方案1（Web Station静态部署）
- 数据存储在LocalStorage
- 添加数据导出/导入功能（JSON格式）

**第二阶段（如需多设备）**：
- 升级为方案2（Docker部署）
- 添加轻量级Node.js后端
- 使用JSON文件存储数据
- 实现数据API接口

### 群晖NAS部署注意事项

1. **文件权限**：确保Web Station有读取项目文件的权限
2. **端口配置**：如使用Docker，需要配置端口映射
3. **HTTPS支持**：建议配置SSL证书，使用HTTPS访问
4. **备份策略**：定期备份数据文件（JSON或数据库）
5. **访问控制**：可通过群晖的用户权限系统控制访问

### Docker部署示例结构

```
majgame/
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
├── server/              # 后端服务（如需要）
│   ├── app.js
│   ├── routes/
│   └── data/           # 数据存储目录
├── public/             # 前端静态文件
│   ├── index.html
│   ├── css/
│   └── js/
└── README.md
```

## 未来扩展功能

- 支持自定义参赛人数和桌数
- 支持自定义比赛场次
- 导出比赛数据（Excel/PDF）
- 历史比赛记录查看
- 积分统计图表
- 多设备同步（需要后端支持）
- 群晖NAS集成（用户认证、文件共享）

